# ğŸ“š 17.æœ‰å¹¶å‘é™åˆ¶çš„promiseall

## ğŸ’» ä»£ç å®ç°
```typescript
/** https://github.com/Sunny-117/js-challenges/issues/147 */
// async-poolæ€æƒ³ å’Œ composeæ€æƒ³ åŸºäºé€’å½’

function limitPromiseAll(promises, limit, retryCount = 3) {
    return new Promise(async (resolve, reject) => {
        let count = 0
        const result = []
        const currentTask = new Set()

        // æ·»åŠ é‡è¯•åŒ…è£…å‡½æ•°
        const retry = async (fn, index) => {
            for (let i = 0; i < retryCount; i++) {
                try {
                    return await fn()
                } catch (err) {
                    if (i === retryCount - 1) throw err
                    console.log(`ä»»åŠ¡${index}ç¬¬${i + 1}æ¬¡é‡è¯•`)
                }
            }
        }

        for (let i = 0; i < promises.length; i++) {
            if (currentTask.size >= limit) {
                await Promise.race(currentTask)
            }
            const promise = promises[i]
            const task = retry(promise, i).then(res => {
                result[i] = res
                currentTask.delete(task)
            }).catch(err => {
                reject(err)
            }).finally(() => {
                count++
                if (count === promises.length) {
                    resolve(result)
                }
            })
            currentTask.add(task)
        }
    })
}

// æµ‹è¯•ç”¨ä¾‹
async function test() {
    // æ¨¡æ‹Ÿå¼‚æ­¥ä»»åŠ¡ï¼Œè¿”å›ä¸€ä¸ª Promise å‡½æ•°
    const createTask = (time, value) => () => {
        console.log(`å¼€å§‹ä»»åŠ¡ ${value}`);
        return new Promise(resolve => {
            setTimeout(() => {
                console.log(`å®Œæˆä»»åŠ¡ ${value}`);
                resolve(value);
            }, time);
        });
    };

    // åˆ›å»ºæµ‹è¯•ä»»åŠ¡
    const tasks = [
        createTask(1000, 1),  // 1ç§’åå®Œæˆ
        createTask(2000, 2),  // 2ç§’åå®Œæˆ
        createTask(1000, 3),  // 1ç§’åå®Œæˆ
        createTask(1500, 4),  // 1.5ç§’åå®Œæˆ
        createTask(500, 5),   // 0.5ç§’åå®Œæˆ
    ];

    try {
        console.time('æ€»æ‰§è¡Œæ—¶é—´');
        const results = await limitPromiseAll(tasks, 2);  // é™åˆ¶å¹¶å‘æ•°ä¸º2
        console.timeEnd('æ€»æ‰§è¡Œæ—¶é—´');
        console.log('æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœ:', results);
    } catch (err) {
        console.error('æ‰§è¡Œå‡ºé”™:', err);
    }
}

test();

```
